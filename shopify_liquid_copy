<style>
/* ====== FORM WRAPPER ====== */
.spiritual-container {
  max-width: 640px;
  margin: 30px auto;
  background: #ffffff;
  padding: 20px 22px;
  border-radius: 14px;
  border: 1px solid #ddd;
  box-shadow: 0 6px 24px rgba(0,0,0,0.12);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

/* Title */
.spiritual-container h2 {
  text-align: center;
  font-size: 1.6rem;
  margin-bottom: 14px;
  color: #4B0082;
}

/* Field labels */
.spiritual-form label {
  font-weight: 600;
  margin-bottom: 6px;
  display: block;
  color: #333;
}

/* Inputs */
.spiritual-form input,
.spiritual-form textarea {
  width: 100%;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid #bbb;
  font-size: 1rem;
  margin-bottom: 14px;
}

#question {
  min-height: 90px;
  resize: vertical;
}

/* Personal toggle */
.personal-toggle {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 18px;
  cursor: pointer;
}

.personal-toggle input {
  width: 20px;
  height: 20px;
}

/* SLIDE-DOWN personal fields */
#personal-fields {
  display: none;
  overflow: hidden;
  transition: max-height 0.35s ease;
  max-height: 0;
}

/* Button */
.btn-primary {
  background: #6c63ff;
  color: #fff;
  padding: 12px 18px;
  border-radius: 10px;
  border: none;
  font-size: 1.05rem;
  cursor: pointer;
  width: 100%;
  margin-top: 10px;
  font-weight: 600;
}

/* Progress + Spinner */
.progress-wrapper {
  margin-top: 15px;
}
.progress-bar {
  width: 100%;
  height: 8px;
  background: #eee;
  border-radius: 8px;
  overflow: hidden;
}
.progress-bar-inner {
  width: 0%;
  height: 100%;
  background: linear-gradient(90deg, #6c63ff, #8c7cff);
  transition: width 0.3s linear;
}

.spinner {
  display: none;
  text-align: center;
  margin-top: 8px;
  color: #6c63ff;
}

/* Summary Output */
#summary-container {
  display: none;
  margin-top: 20px;
}
.summary-box {
  background: #f3f1ff;
  padding: 14px;
  border-radius: 10px;
}

/* Detailed Report */
#detailed-btn {
  margin-top: 14px;
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  background: #4caf50;
  color: #fff;
  border: none;
  font-weight: 600;
  cursor: pointer;
}

/* MODAL */
.modal-overlay {
  display: none;
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.55);
  z-index: 9999;
}

.modal-box {
  max-width: 380px;
  margin: 120px auto;
  background: white;
  padding: 20px;
  border-radius: 12px;
  text-align:center;
  box-shadow:0 6px 24px rgba(0,0,0,0.2);
}

.modal-box input {
  width: 100%;
  padding:10px;
  margin-top:12px;
  border:1px solid #bbb;
  border-radius:8px;
}

.modal-box button {
  margin-top:14px;
  background:#4caf50;
  color:white;
  padding:12px;
  border:none;
  width:100%;
  border-radius:10px;
  font-weight:600;
  cursor:pointer;
}

.modal-close {
  margin-top:10px;
  background:#bbb;
}

/* Mobile */
@media (max-width:600px){
  .spiritual-container { margin:10px; padding:18px; }
}
</style>

<div class="spiritual-container">
  <h2>Your Question</h2>

  <form id="spiritual-form" class="spiritual-form" enctype="multipart/form-data">

    <label class="personal-toggle">
      <input type="checkbox" id="isPersonal" name="isPersonal" />
      <span>Is this a personal question? (enter personal information)</span>
    </label>

    <label>Your Question (max 25 words)</label>
    <textarea id="question" name="question" maxlength="200" placeholder="Example: Should I change jobs next year?"></textarea>

    <!-- Personal fields -->
    <div id="personal-fields">
      <label>Email</label>
      <input type="email" id="email" name="email" />

      <label>Full Name</label>
      <input type="text" id="name" name="name" />

      <label>Date of Birth (DD-MM-YYYY)</label>
      <input type="text" id="birthdate" name="birthdate" placeholder="13-03-1995" />

      <label>Time of Birth</label>
      <input type="text" id="birthtime" name="birthtime" placeholder="09:00" />

      <label>City</label>
      <input type="text" id="birthcity" name="birthcity" />

      <label>State</label>
      <input type="text" id="birthstate" name="birthstate" />

      <label>Country</label>
      <input type="text" id="birthcountry" name="birthcountry" />

      <label>Right Palm Image (optional)</label>
      <input type="file" id="palmImage" name="palmImage" accept="image/*" />
    </div>

    <!-- reCAPTCHA visible checkbox -->
    <div id="recaptcha-box" style="margin: 12px 0;"></div>

    <button type="submit" class="btn-primary">Get Answer</button>

    <div class="progress-wrapper">
      <div class="progress-bar"><div id="progress-inner" class="progress-bar-inner"></div></div>
      <div id="spinner" class="spinner">Processing… please wait ⏳</div>
    </div>
  </form>

  <div id="summary-container">
    <h3>Short Answer</h3>
    <div id="answer-summary" class="summary-box">—</div>

    <button id="detailed-btn">Get Detailed Report (Free)</button>
  </div>
</div>

<!-- MODAL for technical email collection -->
<div id="email-modal" class="modal-overlay">
  <div class="modal-box">
    <h3>Enter your email to receive the full PDF</h3>
    <input type="email" id="modal-email" placeholder="you@example.com" />
    <button id="modal-send">Send Report</button>
    <button class="modal-close" id="modal-close">Cancel</button>
  </div>
</div>

<!-- reCAPTCHA -->
<script src="https://www.google.com/recaptcha/api.js?onload=onLoadRecaptcha&render=explicit" async defer></script>

<script>
const API_SHORT = "https://answers-rust.vercel.app/api/spiritual-report";
const API_PDF   = "https://answers-rust.vercel.app/api/detailed-report";

let recaptchaWidgetId = null;
let recaptchaReady = false;

// =============== reCAPTCHA ===============
function onLoadRecaptcha(){
  const box = document.getElementById("recaptcha-box");
  recaptchaWidgetId = grecaptcha.render("recaptcha-box", {
    sitekey: "6LdAOgYsAAAAAFgNlxLkahtIAbZc4XcIJt2hfLsj",
    theme:"light",
    size:"normal",
  });
  recaptchaReady = true;
}

// =============== Slide-down ===============
const personalCheckbox = document.getElementById("isPersonal");
const personalFields = document.getElementById("personal-fields");

personalCheckbox.addEventListener("change",()=>{
  if(personalCheckbox.checked){
    personalFields.style.display="block";
    personalFields.style.maxHeight = personalFields.scrollHeight+"px";
  } else {
    personalFields.style.maxHeight="0px";
    setTimeout(()=>personalFields.style.display="none",300);
  }
});

// =============== Submit Short Answer ===============
const form = document.getElementById("spiritual-form");
const progressInner = document.getElementById("progress-inner");
const spinner = document.getElementById("spinner");
const summary = document.getElementById("summary-container");
const answerBox = document.getElementById("answer-summary");

let lastShortAnswer = "";
let lastPayload = null;

function animateProgress(){
  progressInner.style.width="0%";
  setTimeout(()=>progressInner.style.width="35%",100);
  setTimeout(()=>progressInner.style.width="70%",600);
  setTimeout(()=>progressInner.style.width="90%",1200);
}

function finishProgress(){
  progressInner.style.width="100%";
  setTimeout(()=>progressInner.style.width="0%",1500);
}

form.addEventListener("submit", async e=>{
  e.preventDefault();
  if(!recaptchaReady) return alert("reCAPTCHA loading...");

  const token = grecaptcha.getResponse(recaptchaWidgetId);
  if(!token) return alert("Please complete the reCAPTCHA");

  spinner.style.display="block";
  animateProgress();

  const fd = new FormData(form);
  fd.append("g-recaptcha-response", token);

  let json;
  try{
    const r = await fetch(API_SHORT,{ method:"POST", body:fd });
    const tx = await r.text();
    json = JSON.parse(tx);
  }catch(err){
    spinner.style.display="none";
    finishProgress();
    return alert("Server error: "+err.message);
  }

  spinner.style.display="none";
  finishProgress();

  // Save payload for PDF
  lastPayload = json;

  let ans = json.answer || "No answer.";
  const low = ans.toLowerCase();
  if(low.includes("policy") || low.includes("not permitted") || low.includes("cannot assist"))
    ans = "⚠️ Censored by OpenAI — this question cannot be answered.";

  lastShortAnswer = ans;

  answerBox.textContent = ans;
  summary.style.display="block";

  grecaptcha.reset(recaptchaWidgetId);
});

// =============== Modal for Technical PDF ===============
const modal = document.getElementById("email-modal");
const modalEmail = document.getElementById("modal-email");
const modalSend = document.getElementById("modal-send");
const modalClose = document.getElementById("modal-close");

// Open modal if technical question
const detailedBtn = document.getElementById("detailed-btn");
detailedBtn.addEventListener("click", ()=>{
  if(!lastPayload) return alert("No answer yet.");

  if(lastPayload.personal){
    alert("Your detailed report has already been emailed!");
  } else {
    modal.style.display="block";
  }
});

modalClose.addEventListener("click", ()=> modal.style.display="none");

// Send PDF request
modalSend.addEventListener("click", async ()=>{
  const email = modalEmail.value.trim();
  if(!email) return alert("Enter your email");

  const fd = new FormData();
  fd.append("email", email);
  fd.append("question", form.querySelector("#question").value);
  fd.append("answer", lastShortAnswer);
  fd.append("personal", "false");

  fd.append("astrologySummary", lastPayload.astrologySummary||"");
  fd.append("numerologySummary", lastPayload.numerologySummary||"");
  fd.append("palmistrySummary", lastPayload.palmistrySummary||"");
  fd.append("numerologyPack", JSON.stringify(lastPayload.numerologyPack||{}));

  try{
    const r = await fetch(API_PDF,{ method:"POST", body:fd });
    const tx = await r.text();
    const js = JSON.parse(tx);

    if(js.success){
      modal.style.display="none";
      alert("Your detailed report has been emailed!");
    } else {
      alert("Error: "+(js.error||"unknown"));
    }
  }catch(err){
    alert("Server error: "+err.message);
  }
});
</script>
