<style>
/* (STYLE SECTION UNCHANGED – omitted for brevity) */
</style>

<div class="spiritual-container">
  <h2>Your Question</h2>

  <form id="spiritual-form" class="spiritual-form" enctype="multipart/form-data">
    <!-- PERSONAL QUESTION TOGGLE -->
    <label class="personal-toggle">
      <input type="checkbox" id="isPersonal" name="isPersonal" />
      <span>Is this a personal question? (enter personal information)</span>
    </label>

    <!-- QUESTION -->
    <label>Your Question (max 25 words)</label>
    <textarea id="question" name="question" maxlength="200"
              placeholder="Example: Should I change jobs next year?"></textarea>

    <!-- PERSONAL FIELDS -->
    <div id="personal-fields">
      <label>Email</label>
      <input type="email" id="email" name="email" />

      <label>Full Name</label>
      <input type="text" id="fullName" name="fullName" />

      <label>Date of Birth (YYYY-MM-DD)</label>
      <input type="date" id="birthDate" name="birthDate" />

      <label>Time of Birth (HH:MM)</label>
      <input type="time" id="birthTime" name="birthTime" />

      <label>City of Birth</label>
      <input type="text" id="birthCity" name="" />

      <label>State / Region</label>
      <input type="text" id="birthState" name="" />

      <label>Country of Birth</label>
      <input type="text" id="birthCountry" name="" />

      <label>Upload Right Palm (optional)</label>
      <input type="file" name="palmImage" accept="image/*" />
    </div>

    <!-- RECAPTCHA -->
    <div id="recaptcha-box" style="margin: 12px 0;"></div>

    <button type="submit" class="btn-primary">Get Answer</button>

    <!-- PROGRESS -->
    <div class="progress-wrapper">
      <div class="progress-bar"><div class="progress-bar-inner" id="progress-inner"></div></div>
      <div class="spinner" id="spinner">Processing… please wait ⏳</div>
    </div>
  </form>

  <div id="summary-container">
    <h3>Short Answer</h3>
    <div class="summary-box" id="answer-summary">—</div>

    <button id="detailed-btn">Get Detailed Report (Free)</button>
  </div>
</div>


<!-- ===== MODAL ===== -->
<div id="email-modal-backdrop">
  <div id="email-modal">
    <h3>Enter your email to receive the full PDF</h3>
    <input type="email" id="modal-email" placeholder="you@example.com" />
    <button id="modal-send" class="modal-btn modal-send">Send Report</button>
    <button id="modal-cancel" class="modal-btn modal-cancel">Cancel</button>
  </div>
</div>

<script src="https://www.google.com/recaptcha/api.js?onload=onLoadRecaptcha&render=explicit" async defer></script>

<script>
/* ============================================================
   CONFIG
============================================================ */
const API_SUMMARY = "https://answers-rust.vercel.app/api/spiritual-report";
const API_PDF = "https://answers-rust.vercel.app/api/detailed-report";

let recaptchaWidgetId = null;

/* ============================================================
   RECAPTCHA LOADER
============================================================ */
function onLoadRecaptcha() {
  recaptchaWidgetId = grecaptcha.render("recaptcha-box", {
    sitekey: "6LdAOgYsAAAAAFgNlxLkahtIAbZc4XcIJt2hfLsj",
    size: "normal"
  });
}

/* ============================================================
   DOM REFERENCES
============================================================ */
const form = document.getElementById("spiritual-form");
const personalCheckbox = document.getElementById("isPersonal");
const personalFields = document.getElementById("personal-fields");

const summaryContainer = document.getElementById("summary-container");
const answerSummary = document.getElementById("answer-summary");
const detailedBtn = document.getElementById("detailed-btn");

const spinner = document.getElementById("spinner");
const progressInner = document.getElementById("progress-inner");

const modalBackdrop = document.getElementById("email-modal-backdrop");
const modalEmail = document.getElementById("modal-email");
const modalSend = document.getElementById("modal-send");
const modalCancel = document.getElementById("modal-cancel");

/* ============================================================
   PERSONAL FIELDS SLIDE DOWN
============================================================ */
personalCheckbox.addEventListener("change", () => {
  if (personalCheckbox.checked) {
    personalFields.style.display = "block";
    personalFields.style.maxHeight = personalFields.scrollHeight + "px";
  } else {
    personalFields.style.maxHeight = "0px";
    setTimeout(() => { personalFields.style.display = "none"; }, 300);
  }
});

/* ============================================================
   PROGRESS UTILS
============================================================ */
function animateProgress() {
  progressInner.style.width = "0%";
  setTimeout(() => progressInner.style.width = "40%", 100);
  setTimeout(() => progressInner.style.width = "80%", 600);
}
function finishProgress() {
  progressInner.style.width = "100%";
  setTimeout(() => progressInner.style.width = "0%", 1500);
}

/* ============================================================
   SUBMIT FORM → GET SHORT ANSWER
============================================================ */
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const token = grecaptcha.getResponse(recaptchaWidgetId);
  if (!token) {
    alert("Please complete the reCAPTCHA.");
    return;
  }

  spinner.style.display = "block";
  animateProgress();

  const fd = new FormData(form);
  fd.append("recaptchaToken", token);

  // Build birthPlace combined string
  const city = document.getElementById("birthCity").value.trim();
  const state = document.getElementById("birthState").value.trim();
  const country = document.getElementById("birthCountry").value.trim();
  if (city || state || country) {
    fd.append("birthPlace", `${city}, ${state}, ${country}`);
  }

  let result;

  try {
    const raw = await fetch(API_SUMMARY, { method: "POST", body: fd });
    const text = await raw.text();
    result = JSON.parse(text);
  } catch (err) {
    spinner.style.display = "none";
    finishProgress();
    alert("Server error: " + err.message);
    return;
  }

  spinner.style.display = "none";
  finishProgress();

  /* Backend now returns: result.shortAnswer */
  let answer = result.shortAnswer || "No answer received.";

  if (
    answer.toLowerCase().includes("not permitted") ||
    answer.toLowerCase().includes("policy")
  ) {
    answer = "⚠️ Censored by OpenAI — this question cannot be answered.";
  }

  answerSummary.textContent = answer;
  summaryContainer.style.display = "block";

  /* Hide detailed button if personal report emailed */
  if (result.pdfEmailed === true) {
    detailedBtn.style.display = "none";
  } else {
    detailedBtn.style.display = "block";
  }

  grecaptcha.reset(recaptchaWidgetId);
});

/* ============================================================
   DETAILED REPORT BUTTON
============================================================ */
detailedBtn.addEventListener("click", () => {
  const isPersonal = personalCheckbox.checked;
  const emailField = document.getElementById("email")?.value.trim();

  // PERSONAL MODE → already emailed automatically
  if (isPersonal) {
    alert("Your full personal report has already been emailed to you.");
    return;
  }

  modalBackdrop.style.display = "flex";
});

modalCancel.addEventListener("click", () => {
  modalBackdrop.style.display = "none";
});

/* ============================================================
   SEND TECHNICAL REPORT EMAIL → /api/detailed-report
============================================================ */
modalSend.addEventListener("click", async () => {
  const email = modalEmail.value.trim();
  if (!email) {
    alert("Please enter a valid email.");
    return;
  }

  modalBackdrop.style.display = "none";

  const body = JSON.stringify({
    email,
    question: document.getElementById("question").value.trim()
  });

  try {
    const raw = await fetch(API_PDF, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body
    });

    const result = await raw.json();

    if (!result.ok) {
      alert("Failed to send report: " + result.error);
      return;
    }

    alert("Your detailed report has been emailed.");
  } catch (err) {
    alert("Server error: " + err.message);
  }
});
</script>
